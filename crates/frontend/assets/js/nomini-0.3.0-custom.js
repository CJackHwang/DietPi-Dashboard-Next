(()=>{const n=(e,t,n)=>{n={bubbles:!0,detail:{},...n},e.dispatchEvent(new CustomEvent(t,n))},i=(e,t,n)=>{/^{.*}$/s.test(e)&&(e=e.slice(1,-1));try{return new Function("__data",`with(__data) {return {${e}}}`).call(n,t)}catch(t){return console.error("[Nomini] failed to parse obj:",e,`
`,t),{}}},s=(e,t)=>{const n=e.matches(t)?[e]:[];return[...n,...e.querySelectorAll(t)].filter(e=>!e.closest("[nm-ignore]"))},a=e=>e.closest("[nm-data]")?.nmProxy||l(),r=t=>{e=t,e(),e=null},c=(e,n)=>{t=e,n(),t=null};let e=null,t=null;const l=()=>({$refs:{},_nmFetching:!1,_nmAbort:new AbortController,$get(e,t){this.$fetch(e,"GET",t)},$post(e,t){this.$fetch(e,"POST",t)},$fetch(e,s,o){const r=t;this._nmAbort.abort(),this._nmAbort=new AbortController,this._nmFetching=!0;const i={headers:{"nm-request":!0},method:s,signal:this._nmAbort.signal};o={...this.$nmData(),...this.$dataset(),...o};const a=new URLSearchParams(o);/GET|DELETE/.test(s)?e+=(e.includes("?")?"&":"?")+a:i.body=a,fetch(e,i).then(async e=>{if(!e.ok){const t=await e.text();throw new Error(`${e.statusText}: ${t}`)}const t=new TextDecoder;for await(const n of e.body){const s=t.decode(n);d(s)}}).catch(t=>n(r,"fetcherr",{detail:{err:t,url:e}})).finally(()=>this._nmFetching=!1)},$nmData(){const e=e=>e!==Object(e);return Object.entries(this).reduce((t,[n,s])=>/^[a-z]+$/i.test(n)?(typeof s=="function"&&(s=s()),(e(s)||Array.isArray(s)&&s.every(e))&&(t[n]=s),t):t,{})},$dataset(){let n={},e=t;for(;e;){if(n={...e.dataset,...n},e.hasAttribute("nm-data"))break;e=e.parentElement}return n},$watch:r,$dispatch(e,s,o){n(t,e,{detail:s,...o})},$debounce(e,n,s=!0){const o=t,i=this._nmAbort.signal;clearTimeout(o.nmTimer),o.nmTimer=setTimeout(()=>{s&&i.aborted||c(o,e)},n)}}),d=e=>{const t=document.createElement("template");t.innerHTML=e;for(const e of t.content.children){if(!e.id){console.warn("[Nomini] Fragment is missing an id: ",e);continue}const a=e.getAttribute("nm-swap")||"outer",i=document.getElementById(e.id);if(!i){console.warn("[Nomini] Swap target not found: #",e.id);continue}if(s(i,"[nm-bind]").forEach(e=>n(e,"destroy",{bubbles:!1})),a==="inner")i.replaceChildren(...e.childNodes),o(i);else if(a==="outer")i.replaceWith(e),o(e);else if(/(before|after|prepend|append)/.test(a)){const t=[...e.childNodes];i[a](...t),t.forEach(e=>e.nodeType===1&&o(e))}else console.error("[Nomini] Invalid swap strategy: ",a)}},o=t=>{s(t,"[nm-data]").forEach(t=>{const s={...i(t.getAttribute("nm-data"),{},t),...l()},n={},o=new Proxy(s,{get(t,s){return e&&(n[s]||=new Set).add(e),t[s]},set(t,s,o){t[s]=o;const i=n[s];if(i){const t=e;e=null,i.forEach(e=>e()),e=t}return!0}});t.nmProxy=o}),s(t,"[nm-ref]").forEach(e=>{const t=a(e),n=e.getAttribute("nm-ref");t.$refs[n]=e}),s(t,"[nm-bind]").forEach(e=>{const t=a(e),s=i(e.getAttribute("nm-bind"),t,e);Object.entries(s).forEach(([t,n])=>{if(t.startsWith("on"))e.addEventListener(t.slice(2),()=>c(n));else{const[s,o]=t.split(".");c(e,()=>r(async()=>{const t=await n();o?s==="class"?e.classList.toggle(o,t):e[s][o]=t:e[s]=t}))}}),n(e,"init",{bubbles:!1})})};document.addEventListener("DOMContentLoaded",()=>o(document.body))})();